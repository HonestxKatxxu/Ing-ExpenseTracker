@page "/transactions"
@using Ing_ExpenseTracker.Models
@inject UserService UserService

<div class="container mt-5">
    <h1 class="text-primary mb-4">Transactions</h1>

    <!-- Filter and Sort Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="card-title text-info">Filter and Sort Transactions</h2>
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" @bind="SearchQuery" placeholder="Search transactions..." class="form-control" />
                </div>
                <div class="col-md-3">
                    <select @bind="SelectedType" class="form-select">
                        <option value="">All Types</option>
                        <option value="Inflow">Inflow</option>
                        <option value="Outflow">Outflow</option>
                        <option value="Debt">Debt</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" @bind="StartDate" class="form-control" />
                </div>
                <div class="col-md-2">
                    <input type="date" @bind="EndDate" class="form-control" />
                </div>
                <div class="col-md-2">
                    <select @bind="SortBy" class="form-select">
                        <option value="DateAsc">Sort by Date (Asc)</option>
                        <option value="DateDesc">Sort by Date (Desc)</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary w-100" @onclick="FilterTransactions">Filter Transactions</button>
            </div>
        </div>
    </div>

    <!-- Transaction Summary Section -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-success">Total Transactions</h4>
                    <p class="display-6">@TotalTransactions</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-info">Net Total</h4>
                    <p class="display-6">@NetTotal</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-warning">Highest Transactions</h4>
                    <ul class="list-unstyled">
                        <li><strong>Inflow:</strong> @HighestInflow</li>
                        <li><strong>Outflow:</strong> @HighestOutflow</li>
                        <li><strong>Debt:</strong> @HighestDebt</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="card-title text-info">All Transactions</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th>Date</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Tags</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (FilteredTransactions != null && FilteredTransactions.Any())
                        {
                            @foreach (var transaction in FilteredTransactions)
                            {
                                <tr>
                                    <td>@transaction.Date.ToString("MM/dd/yyyy")</td>
                                    <td>@transaction.Description</td>
                                    <td>@transaction.Type</td>
                                    <td>@(transaction.Debit > 0 ? $"-{transaction.Debit}" : transaction.Credit)</td>
                                    <td>@transaction.Tags</td>
                                    <td>@transaction.Notes</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">No transactions available.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Transaction> AllTransactions = new();
    private List<Transaction> FilteredTransactions = new();
    private string SearchQuery = "";
    private string SelectedType = "";
    private DateTime? StartDate = null;
    private DateTime? EndDate = null;
    private string SortBy = "DateDesc";

    private int TotalTransactions = 0;
    private decimal NetTotal = 0;

    private decimal HighestInflow = 0;
    private decimal LowestInflow = 0;
    private decimal HighestOutflow = 0;
    private decimal LowestOutflow = 0;
    private decimal HighestDebt = 0;
    private decimal LowestDebt = 0;

    protected override void OnInitialized()
    {
        try
        {
            var data = UserService.LoadUsers();
            AllTransactions = data?.Transactions ?? new List<Transaction>();

            CalculateSummary();
            FilteredTransactions = AllTransactions.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing transactions: {ex.Message}");
        }
    }

    private void CalculateSummary()
    {
        TotalTransactions = AllTransactions.Count;

        NetTotal = AllTransactions.Sum(t => t.Credit - t.Debit);

        HighestInflow = AllTransactions.Where(t => t.Credit > 0).DefaultIfEmpty(new Transaction()).Max(t => t.Credit);
        LowestInflow = AllTransactions.Where(t => t.Credit > 0).DefaultIfEmpty(new Transaction { Credit = decimal.MaxValue }).Min(t => t.Credit);

        HighestOutflow = AllTransactions.Where(t => t.Debit > 0).DefaultIfEmpty(new Transaction()).Max(t => t.Debit);
        LowestOutflow = AllTransactions.Where(t => t.Debit > 0).DefaultIfEmpty(new Transaction { Debit = decimal.MaxValue }).Min(t => t.Debit);

        HighestDebt = AllTransactions.Where(t => t.Type == "Debt").DefaultIfEmpty(new Transaction()).Max(t => t.Debit);
        LowestDebt = AllTransactions.Where(t => t.Type == "Debt").DefaultIfEmpty(new Transaction { Debit = decimal.MaxValue }).Min(t => t.Debit);
    }

    private void FilterTransactions()
    {
        FilteredTransactions = AllTransactions;

        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            FilteredTransactions = FilteredTransactions
                .Where(t => t.Description?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false)
                .ToList();
        }

        if (!string.IsNullOrWhiteSpace(SelectedType))
        {
            FilteredTransactions = FilteredTransactions
                .Where(t => t.Type?.Equals(SelectedType, StringComparison.OrdinalIgnoreCase) ?? false)
                .ToList();
        }

        if (StartDate.HasValue && EndDate.HasValue)
        {
            FilteredTransactions = FilteredTransactions
                .Where(t => t.Date >= StartDate && t.Date <= EndDate)
                .ToList();
        }

        FilteredTransactions = SortBy switch
        {
            "DateAsc" => FilteredTransactions.OrderBy(t => t.Date).ToList(),
            "DateDesc" => FilteredTransactions.OrderByDescending(t => t.Date).ToList(),
            _ => FilteredTransactions
        };
    }
}
